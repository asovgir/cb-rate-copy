<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloudbeds Rate Copier</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>üè® Cloudbeds Rate Copier</h1>
        </header>

        <div class="config-panel">
            <div class="config-row">
                <div class="config-item">
                    <label for="bearerToken">Bearer Token</label>
                    <input type="password" id="bearerToken" placeholder="Enter Bearer Token">
                </div>
                <div class="config-item">
                    <label for="propertyID">Property ID</label>
                    <input type="text" id="propertyID" placeholder="Property ID">
                </div>
                <div class="config-item">
                    <button class="btn btn-primary" onclick="loadRoomTypes()">Load Room Types</button>
                </div>
            </div>
        </div>

        <div id="loadingIndicator" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Loading...</p>
        </div>

        <!-- MAIN VIEW -->
        <div id="basicView" style="display: none;">
            <div class="basic-container">
                <div class="basic-section">
                    <h3>1. Select Room Types</h3>
                    <div class="room-type-selector">
                        <button class="btn-small" onclick="selectAllRoomTypes()">Select All</button>
                        <button class="btn-small" onclick="clearAllRoomTypes()">Clear All</button>
                        <div id="roomTypeCheckboxes" class="checkbox-grid"></div>
                    </div>
                </div>

                <div class="basic-section">
                    <h3>2. Date Range to Copy FROM</h3>
                    <div class="date-range-group">
                        <div class="config-item">
                            <label>Start Date</label>
                            <input type="date" id="basicFromStart" value="2025-12-01">
                        </div>
                        <div class="config-item">
                            <label>End Date</label>
                            <input type="date" id="basicFromEnd" value="2025-12-31">
                        </div>
                    </div>
                </div>

                <div class="basic-section">
                    <h3>3. Select Rate Plans</h3>
                    <div class="rate-plan-selector">
                        <button class="btn-small" onclick="loadRatePlans()">Load Rate Plans</button>
                        <div id="ratePlanCheckboxes" class="checkbox-grid" style="display: none; margin-top: 10px;"></div>
                    </div>
                </div>

                <div class="basic-section">
                    <h3>4. Years to Copy TO</h3>
                    <div class="year-selector">
                        <label class="checkbox-label">
                            <input type="checkbox" value="2026" class="basic-year-checkbox">
                            <span>2026</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" value="2027" class="basic-year-checkbox">
                            <span>2027</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" value="2028" class="basic-year-checkbox">
                            <span>2028</span>
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" value="2029" class="basic-year-checkbox">
                            <span>2029</span>
                        </label>
                    </div>
                    <div class="warning-box">
                        ‚ö†Ô∏è <strong>Day-of-Week Matching:</strong> Rates will be copied to the <strong>same day of week</strong> in future years.<br>
                        Example: Saturday Dec 13, 2025 ‚Üí Saturday Dec 12, 2026 (NOT Sunday Dec 13, 2026)
                    </div>
                </div>

                <div class="basic-section">
                    <button class="btn btn-primary btn-large" onclick="executeBasicCopy()">
                        Preview Rate Changes
                    </button>
                    <div id="basicSummary" class="summary-info"></div>
                </div>
            </div>
        </div>

        <div id="resultsPanel" style="display: none;">
            <div class="results-header">
                <h3>Results</h3>
                <button class="btn-small" onclick="clearResults()">Clear</button>
            </div>
            <div id="resultsList"></div>
        </div>

        <!-- PREVIEW/CONFIRMATION MODAL -->
        <div id="previewModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Review & Confirm Rate Changes</h2>
                    <button class="btn-close" onclick="closePreview()">√ó</button>
                </div>

                <div class="modal-body">
                    <div class="preview-summary"></div>

                    <div class="preview-filters" style="margin-bottom: 15px; padding: 12px; background: #f5f5f5; border: 1px solid #d0d0d0; border-radius: 4px;">
                        <div style="display: flex; gap: 15px; align-items: flex-end;">
                            <div style="flex: 1;">
                                <label style="font-size: 10px; font-weight: 600; display: block; margin-bottom: 3px;">Filter by Room Type:</label>
                                <select id="filterRoomType" onchange="applyPreviewFilters()" style="width: 100%; padding: 5px; border: 1px solid #ababab; font-size: 11px;">
                                    <option value="">All Room Types</option>
                                </select>
                            </div>
                            <div style="flex: 1;">
                                <label style="font-size: 10px; font-weight: 600; display: block; margin-bottom: 3px;">Filter by Rate Plan:</label>
                                <select id="filterRatePlan" onchange="applyPreviewFilters()" style="width: 100%; padding: 5px; border: 1px solid #ababab; font-size: 11px;">
                                    <option value="">All Rate Plans</option>
                                </select>
                            </div>
                            <button class="btn-small" onclick="clearPreviewFilters()" style="padding: 5px 12px;">Clear Filters</button>
                        </div>
                        <div id="filterStats" style="margin-top: 8px; font-size: 10px; color: #666;"></div>
                    </div>

                    <div class="preview-table-wrapper">
                        <table class="preview-table" id="previewTable">
                            <thead id="previewTableHead">
                                <!-- Dynamic headers will be inserted here -->
                            </thead>
                            <tbody id="previewTableBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closePreview()">Cancel</button>
                    <button class="btn btn-primary btn-large" onclick="confirmAndSubmit()">Confirm & Submit All</button>
                </div>
            </div>
        </div>

        <!-- SUCCESS/FAILURE MODAL -->
        <div id="completionModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2 id="completionTitle">Operation Complete</h2>
                    <button class="btn-close" onclick="closeCompletionModal()">√ó</button>
                </div>
                
                <div class="modal-body">
                    <div id="completionSummary" style="padding: 20px; text-align: center;"></div>
                </div>
                
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="closeCompletionModal()">OK</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPropertyID = '';
        let currentBearerToken = '';
        let roomTypesData = [];
        let ratePlansData = [];
        let pendingOperations = [];

        function renderRoomTypeCheckboxes() {
            const container = document.getElementById('roomTypeCheckboxes');
            container.innerHTML = '';

            roomTypesData.forEach(rt => {
                const label = document.createElement('label');
                label.className = 'checkbox-label';
                label.innerHTML = `
                    <input type="checkbox" class="room-type-checkbox" value="${rt.roomTypeID}">
                    <span>${rt.roomTypeName}</span>
                `;
                container.appendChild(label);
            });
        }

        function renderRatePlanCheckboxes() {
            const container = document.getElementById('ratePlanCheckboxes');
            container.innerHTML = '';

            if (ratePlansData.length === 0) {
                container.innerHTML = '<p style="padding: 10px; color: #666;">No rate plans available</p>';
                container.style.display = 'block';
                return;
            }

            ratePlansData.forEach(rp => {
                const label = document.createElement('label');
                label.className = 'checkbox-label';

                // Determine display name - if no ratePlanID, it's the base rate
                let displayName;
                if (!rp.ratePlanID) {
                    displayName = 'Base Rate';
                } else if (rp.ratePlanNamePublic) {
                    displayName = rp.ratePlanNamePublic;
                } else if (rp.ratePlanNamePrivate) {
                    displayName = rp.ratePlanNamePrivate;
                } else {
                    displayName = `Rate Plan ${rp.ratePlanID}`;
                }

                const planId = rp.ratePlanID || 'base';

                label.innerHTML = `
                    <input type="checkbox" class="rate-plan-checkbox" value="${planId}" data-rate-id="${rp.rateID}">
                    <span>${displayName}</span>
                `;
                container.appendChild(label);
            });

            container.style.display = 'block';
        }

        async function loadRoomTypes() {
            const bearerToken = document.getElementById('bearerToken').value.trim();
            const propertyID = document.getElementById('propertyID').value.trim();

            if (!bearerToken || !propertyID) {
                alert('Please fill in Bearer Token and Property ID');
                return;
            }

            currentBearerToken = bearerToken;
            currentPropertyID = propertyID;

            showLoading(true);

            try {
                const response = await fetch(`/api/room-types?propertyID=${propertyID}`, {
                    headers: { 'X-Bearer-Token': bearerToken }
                });
                const data = await response.json();

                if (!response.ok || !data.success) {
                    alert('Error loading room types: ' + (data.error || 'Unknown error'));
                    showLoading(false);
                    return;
                }

                roomTypesData = data.roomTypes;
                renderRoomTypeCheckboxes();
                document.getElementById('basicView').style.display = 'block';
                showLoading(false);
            } catch (error) {
                console.error('Error:', error);
                alert('Error loading data');
                showLoading(false);
            }
        }

        function selectAllRoomTypes() {
            document.querySelectorAll('.room-type-checkbox').forEach(cb => cb.checked = true);
        }

        function clearAllRoomTypes() {
            document.querySelectorAll('.room-type-checkbox').forEach(cb => cb.checked = false);
        }

        async function loadRatePlans() {
            const selectedRoomTypes = Array.from(document.querySelectorAll('.room-type-checkbox:checked'))
                .map(cb => cb.value);
            const startDate = document.getElementById('basicFromStart').value;
            const endDate = document.getElementById('basicFromEnd').value;

            if (selectedRoomTypes.length === 0) {
                alert('Please select at least one room type first');
                return;
            }

            if (!startDate || !endDate) {
                alert('Please select date range first');
                return;
            }

            if (!currentBearerToken || !currentPropertyID) {
                alert('Please load room types first');
                return;
            }

            showLoading(true);
            ratePlansData = [];

            try {
                // Fetch rate plans for the first selected room type
                const roomTypeID = selectedRoomTypes[0];
                const response = await fetch(
                    `/api/rate-plans?propertyID=${currentPropertyID}&roomTypeID=${roomTypeID}&startDate=${startDate}&endDate=${endDate}`,
                    { headers: { 'X-Bearer-Token': currentBearerToken } }
                );
                const data = await response.json();

                if (data.success && data.ratePlans) {
                    ratePlansData = data.ratePlans;
                    renderRatePlanCheckboxes();
                } else {
                    alert('Error loading rate plans: ' + (data.error || 'Unknown error'));
                }

                showLoading(false);
            } catch (error) {
                console.error('Error loading rate plans:', error);
                alert('Error loading rate plans');
                showLoading(false);
            }
        }

        function getDayOfWeekMatch(sourceDate, targetYear) {
            const source = new Date(sourceDate + 'T00:00:00');
            const dayOfWeek = source.getDay();
            
            let target = new Date(targetYear, source.getMonth(), source.getDate());
            const targetDayOfWeek = target.getDay();
            
            let diff = dayOfWeek - targetDayOfWeek;
            
            if (diff > 3) {
                diff -= 7;
            } else if (diff < -3) {
                diff += 7;
            }
            
            target.setDate(target.getDate() + diff);
            
            return target.toISOString().split('T')[0];
        }

        async function executeBasicCopy() {
            const selectedRoomTypes = Array.from(document.querySelectorAll('.room-type-checkbox:checked'))
                .map(cb => cb.value);
            const selectedRatePlans = Array.from(document.querySelectorAll('.rate-plan-checkbox:checked'))
                .map(cb => ({ ratePlanID: cb.value, rateID: cb.dataset.rateId }));
            const selectedYears = Array.from(document.querySelectorAll('.basic-year-checkbox:checked'))
                .map(cb => parseInt(cb.value));
            const fromStart = document.getElementById('basicFromStart').value;
            const fromEnd = document.getElementById('basicFromEnd').value;

            if (selectedRoomTypes.length === 0) {
                alert('Please select at least one room type');
                return;
            }

            if (selectedRatePlans.length === 0) {
                alert('Please select at least one rate plan');
                return;
            }

            if (selectedYears.length === 0) {
                alert('Please select at least one year');
                return;
            }

            if (!fromStart || !fromEnd) {
                alert('Please select date range');
                return;
            }

            showLoading(true);
            const operations = [];

            document.getElementById('basicSummary').textContent = 'Loading rates (batched)...';

            // Load rates in batches by room type and rate plan
            for (const roomTypeID of selectedRoomTypes) {
                for (const ratePlan of selectedRatePlans) {
                    try {
                        console.log(`[BATCH LOAD] Fetching rates for room type ${roomTypeID}, rate plan ${ratePlan.ratePlanID}`);

                        const response = await fetch(
                            `/api/rates-batch?propertyID=${currentPropertyID}&roomTypeID=${roomTypeID}&ratePlanID=${ratePlan.ratePlanID}&startDate=${fromStart}&endDate=${fromEnd}`,
                            { headers: { 'X-Bearer-Token': currentBearerToken } }
                        );
                        const data = await response.json();

                        if (data.success && data.rates) {
                            console.log(`[BATCH LOAD] Loaded ${data.count} rates for room type ${roomTypeID}, rate plan ${ratePlan.ratePlanID}`);

                            // Process each date in the batch response
                            Object.keys(data.rates).forEach(date => {
                                const rate = data.rates[date];

                                // Create operations for each selected year
                                for (const year of selectedYears) {
                                    const targetDate = getDayOfWeekMatch(date, year);
                                    operations.push({
                                        roomTypeID,
                                        ratePlanID: ratePlan.ratePlanID,
                                        sourceDate: date,
                                        targetDate: targetDate,
                                        targetYear: year,
                                        rateData: rate
                                    });
                                }
                            });
                        }
                    } catch (error) {
                        console.error(`[BATCH LOAD] Error loading rates for room type ${roomTypeID}, rate plan ${ratePlan.ratePlanID}:`, error);
                    }
                }
            }

            showLoading(false);
            
            if (operations.length === 0) {
                document.getElementById('basicSummary').textContent = 'No rates found to copy';
                return;
            }
            
            console.log(`[BATCH LOAD] Total operations created: ${operations.length}`);
            document.getElementById('basicSummary').textContent = '';
            showPreview(operations);
        }

        let allGroupedOps = {};  // Store all operations globally for filtering

        function showPreview(operations) {
            pendingOperations = operations;

            // Group operations by unique combinations of roomType, sourceDate, ratePlan
            const groupedOps = {};
            const selectedYears = [...new Set(operations.map(op => op.targetYear))].sort();

            operations.forEach(op => {
                const key = `${op.roomTypeID}_${op.sourceDate}_${op.ratePlanID || 'base'}`;
                if (!groupedOps[key]) {
                    groupedOps[key] = {
                        roomTypeID: op.roomTypeID,
                        ratePlanID: op.ratePlanID,
                        sourceDate: op.sourceDate,
                        rateData: op.rateData,
                        years: {}
                    };
                }
                groupedOps[key].years[op.targetYear] = op;
            });

            allGroupedOps = groupedOps;  // Store for filtering

            const summary = document.querySelector('.preview-summary');
            summary.textContent = `Ready to copy ${operations.length} rate(s). Review and edit rates below before submitting.`;

            // Populate filter dropdowns
            populatePreviewFilters(groupedOps);

            // Render the preview table
            renderPreviewTable(groupedOps, selectedYears);

            document.getElementById('previewModal').style.display = 'flex';
        }

        function populatePreviewFilters(groupedOps) {
            // Get unique room types and rate plans from the operations
            const uniqueRoomTypes = new Set();
            const uniqueRatePlans = new Set();

            Object.values(groupedOps).forEach(group => {
                uniqueRoomTypes.add(group.roomTypeID);
                uniqueRatePlans.add(group.ratePlanID || 'base');
            });

            // Populate room type filter
            const roomTypeSelect = document.getElementById('filterRoomType');
            roomTypeSelect.innerHTML = '<option value="">All Room Types</option>';
            uniqueRoomTypes.forEach(roomTypeID => {
                const roomType = roomTypesData.find(rt => rt.roomTypeID === roomTypeID);
                if (roomType) {
                    const option = document.createElement('option');
                    option.value = roomTypeID;
                    option.textContent = roomType.roomTypeName;
                    roomTypeSelect.appendChild(option);
                }
            });

            // Populate rate plan filter
            const ratePlanSelect = document.getElementById('filterRatePlan');
            ratePlanSelect.innerHTML = '<option value="">All Rate Plans</option>';
            uniqueRatePlans.forEach(ratePlanID => {
                const option = document.createElement('option');
                option.value = ratePlanID;

                if (ratePlanID === 'base') {
                    option.textContent = 'Base Rate';
                } else {
                    const ratePlan = ratePlansData.find(rp => rp.ratePlanID === ratePlanID);
                    option.textContent = ratePlan ?
                        (ratePlan.ratePlanNamePublic || ratePlan.ratePlanNamePrivate || `Plan ${ratePlanID}`) :
                        `Plan ${ratePlanID}`;
                }
                ratePlanSelect.appendChild(option);
            });

            updateFilterStats(groupedOps, groupedOps);
        }

        function applyPreviewFilters() {
            const selectedRoomType = document.getElementById('filterRoomType').value;
            const selectedRatePlan = document.getElementById('filterRatePlan').value;

            // Filter the grouped operations
            const filteredOps = {};
            Object.entries(allGroupedOps).forEach(([key, group]) => {
                const matchesRoomType = !selectedRoomType || group.roomTypeID === selectedRoomType;
                const matchesRatePlan = !selectedRatePlan || (group.ratePlanID || 'base') === selectedRatePlan;

                if (matchesRoomType && matchesRatePlan) {
                    filteredOps[key] = group;
                }
            });

            // Get years from all operations
            const allYears = new Set();
            Object.values(allGroupedOps).forEach(group => {
                Object.keys(group.years).forEach(year => allYears.add(parseInt(year)));
            });
            const selectedYears = [...allYears].sort();

            // Re-render table with filtered data
            renderPreviewTable(filteredOps, selectedYears);

            // Update stats
            updateFilterStats(filteredOps, allGroupedOps);
        }

        function clearPreviewFilters() {
            document.getElementById('filterRoomType').value = '';
            document.getElementById('filterRatePlan').value = '';
            applyPreviewFilters();
        }

        function updateFilterStats(filteredOps, allOps) {
            const filteredCount = Object.keys(filteredOps).length;
            const totalCount = Object.keys(allOps).length;
            const statsEl = document.getElementById('filterStats');

            if (filteredCount === totalCount) {
                statsEl.textContent = `Showing all ${totalCount} record(s)`;
            } else {
                statsEl.textContent = `Showing ${filteredCount} of ${totalCount} record(s)`;
            }
        }

        function renderPreviewTable(groupedOps, selectedYears) {
            // Build table headers
            const thead = document.getElementById('previewTableHead');
            let headerHTML = '<tr><th>Room Type</th><th>Source Date</th><th>Source Day</th><th>Rate Plan</th><th>Source Rate</th>';
            selectedYears.forEach(year => {
                headerHTML += `<th colspan="2" style="text-align: center; background: #1e6139;">${year}</th>`;
            });
            headerHTML += '</tr><tr><th colspan="5"></th>';
            selectedYears.forEach(year => {
                headerHTML += '<th>Target Date</th><th>New Rate</th>';
            });
            headerHTML += '</tr>';
            thead.innerHTML = headerHTML;

            // Build table body
            const tbody = document.getElementById('previewTableBody');
            tbody.innerHTML = '';

            Object.values(groupedOps).forEach(group => {
                const roomType = roomTypesData.find(rt => rt.roomTypeID === group.roomTypeID);
                const sourceDate = new Date(group.sourceDate + 'T00:00:00');
                const sourceDayName = sourceDate.toLocaleDateString('en-US', { weekday: 'short' });
                const isSourceWeekend = sourceDate.getDay() === 5 || sourceDate.getDay() === 6;

                const ratePlan = ratePlansData.find(rp => rp.ratePlanID === group.ratePlanID);
                const ratePlanName = ratePlan ?
                    (ratePlan.ratePlanNamePublic || ratePlan.ratePlanNamePrivate || `Plan ${group.ratePlanID}`) :
                    'Base Rate';

                const rateAmount = group.rateData.rate || group.rateData.roomRate || group.rateData.totalRate || 0;

                const row = document.createElement('tr');
                let rowHTML = `
                    <td>${roomType.roomTypeName}</td>
                    <td class="source-date">${formatDate(group.sourceDate)}</td>
                    <td><span class="day-badge ${isSourceWeekend ? 'weekend' : ''}">${sourceDayName}</span></td>
                    <td>${ratePlanName}</td>
                    <td>$${parseFloat(rateAmount).toFixed(2)}</td>
                `;

                selectedYears.forEach(year => {
                    const yearOp = group.years[year];
                    if (yearOp) {
                        const targetDate = new Date(yearOp.targetDate + 'T00:00:00');
                        const targetDayName = targetDate.toLocaleDateString('en-US', { weekday: 'short' });
                        const isTargetWeekend = targetDate.getDay() === 5 || targetDate.getDay() === 6;

                        // Find the actual index in pendingOperations array
                        const opIndex = pendingOperations.findIndex(op =>
                            op.roomTypeID === yearOp.roomTypeID &&
                            op.sourceDate === yearOp.sourceDate &&
                            op.targetDate === yearOp.targetDate &&
                            op.targetYear === yearOp.targetYear &&
                            (op.ratePlanID || 'base') === (yearOp.ratePlanID || 'base')
                        );

                        rowHTML += `
                            <td>${formatDate(yearOp.targetDate)} <span class="day-badge ${isTargetWeekend ? 'weekend' : ''}">${targetDayName}</span></td>
                            <td>
                                <input type="number"
                                       step="0.01"
                                       min="0"
                                       value="${parseFloat(rateAmount).toFixed(2)}"
                                       data-index="${opIndex}"
                                       onchange="updatePendingRate(${opIndex}, this.value)"
                                       style="width: 80px;">
                            </td>
                        `;
                    } else {
                        rowHTML += '<td>-</td><td>-</td>';
                    }
                });

                row.innerHTML = rowHTML;
                tbody.appendChild(row);
            });
        }

        function isWeekend(date) {
            const day = date.getDay();
            return day === 5 || day === 6;
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function updatePendingRate(index, newRate) {
            const rateAmount = parseFloat(newRate);
            if (!isNaN(rateAmount) && rateAmount >= 0) {
                const operation = pendingOperations[index];
                if (operation.rateData.rate !== undefined) {
                    operation.rateData.rate = rateAmount;
                }
                if (operation.rateData.roomRate !== undefined) {
                    operation.rateData.roomRate = rateAmount;
                }
                if (operation.rateData.totalRate !== undefined) {
                    operation.rateData.totalRate = rateAmount;
                }
            }
        }

        function closePreview() {
            document.getElementById('previewModal').style.display = 'none';
        }

        async function confirmAndSubmit() {
            if (pendingOperations.length === 0) {
                alert('No operations to submit');
                return;
            }
            
            document.getElementById('previewModal').style.display = 'none';
            showLoading(true);
            
            try {
                const results = await executeRateCopies(pendingOperations);
                showLoading(false);
                
                // Show completion modal
                showCompletionModal(results);
                
                // Clear pending operations
                pendingOperations = [];
                
            } catch (error) {
                console.error('[ERROR] Exception in confirmAndSubmit:', error);
                showLoading(false);
                alert('Error submitting rates: ' + error.message);
            }
        }

        async function executeRateCopies(operations) {
            console.log(`[BATCH] Starting batch execution for ${operations.length} operations`);
            
            // Group operations by roomTypeID and rateID
            const batches = {};
            const skipped = [];
            
            operations.forEach(op => {
                const rateID = op.rateData.rateID;
                
                // Skip if no rateID
                if (!rateID) {
                    console.error('[BATCH] Missing rateID for operation:', op);
                    skipped.push({
                        success: false,
                        date: op.targetDate,
                        error: 'Missing rateID in source data'
                    });
                    return;
                }
                
                const roomTypeID = op.roomTypeID;
                const key = `${roomTypeID}_${rateID}`;
                
                if (!batches[key]) {
                    batches[key] = {
                        roomTypeID: roomTypeID,
                        rateID: rateID,
                        intervals: []
                    };
                }
                
                // Build interval object
                const rateAmount = op.rateData.rate || op.rateData.roomRate || op.rateData.totalRate || 0;
                const interval = {
                    startDate: op.targetDate,
                    endDate: op.targetDate,
                    rate: parseFloat(rateAmount)
                };
                
                // Add optional fields
                if (op.rateData.extraPersonRate) {
                    interval.extraPersonRate = parseFloat(op.rateData.extraPersonRate);
                }
                if (op.rateData.maxGuests) {
                    interval.maxGuests = parseInt(op.rateData.maxGuests);
                }
                if (op.rateData.minStay) {
                    interval.minStay = parseInt(op.rateData.minStay);
                }
                if (op.rateData.maxStay) {
                    interval.maxStay = parseInt(op.rateData.maxStay);
                }
                
                batches[key].intervals.push(interval);
            });
            
            const batchArray = Object.values(batches);
            console.log(`[BATCH] Grouped into ${batchArray.length} batches (${skipped.length} skipped)`);
            
            if (batchArray.length === 0) {
                return skipped;
            }
            
            // Send batched request
            try {
                const requestBody = {
                    propertyID: currentPropertyID,
                    batches: batchArray
                };
                
                console.log(`[BATCH] Sending request with ${batchArray.length} batches`);
                
                const response = await fetch('/api/copy-rates-batch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Bearer-Token': currentBearerToken
                    },
                    body: JSON.stringify(requestBody)
                });

                const result = await response.json();
                console.log('[BATCH] Response:', result);
                
                if (result.success) {
                    // Convert batch results to individual operation results
                    const individualResults = [...skipped];
                    result.results.forEach(batchResult => {
                        if (batchResult.success) {
                            // Add success result for each interval in this batch
                            for (let i = 0; i < batchResult.count; i++) {
                                individualResults.push({
                                    success: true,
                                    date: 'Batch',
                                    rate: 'Success'
                                });
                            }
                        } else {
                            // Add failure result for each interval in this batch
                            for (let i = 0; i < batchResult.count; i++) {
                                individualResults.push({
                                    success: false,
                                    date: 'Batch',
                                    error: batchResult.error
                                });
                            }
                        }
                    });
                    
                    console.log(`[BATCH] Completed: ${individualResults.filter(r => r.success).length}/${individualResults.length} successful`);
                    return individualResults;
                } else {
                    console.error('[BATCH] Error:', result.error);
                    return [...skipped, ...operations.map(op => ({
                        success: false,
                        date: op.targetDate,
                        error: result.error || 'Batch request failed'
                    }))];
                }
            } catch (error) {
                console.error('[BATCH] Exception:', error);
                return [...skipped, ...operations.map(op => ({
                    success: false,
                    date: op.targetDate,
                    error: error.message
                }))];
            }
        }

        function showCompletionModal(results) {
            const successCount = results.filter(r => r.success).length;
            const failureCount = results.length - successCount;
            const totalCount = results.length;
            
            const modal = document.getElementById('completionModal');
            const title = document.getElementById('completionTitle');
            const summary = document.getElementById('completionSummary');
            
            let html = '';
            
            if (failureCount === 0) {
                // All successful
                title.textContent = '‚úì Success!';
                title.style.color = '#28a745';
                html = `
                    <div style="font-size: 48px; color: #28a745; margin-bottom: 20px;">‚úì</div>
                    <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">
                        All ${totalCount} rate(s) copied successfully!
                    </div>
                    <div style="font-size: 14px; color: #666; margin-top: 15px;">
                        ‚ö° Batched requests completed in seconds<br>
                        Your rates have been updated in Cloudbeds.
                    </div>
                `;
            } else if (successCount === 0) {
                // All failed
                title.textContent = '‚úó Failed';
                title.style.color = '#dc3545';
                html = `
                    <div style="font-size: 48px; color: #dc3545; margin-bottom: 20px;">‚úó</div>
                    <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">
                        All ${totalCount} operation(s) failed
                    </div>
                    <div style="font-size: 14px; color: #666;">
                        Please check your bearer token and try again.
                    </div>
                `;
            } else {
                // Partial success
                title.textContent = 'Partial Success';
                title.style.color = '#ffc107';
                html = `
                    <div style="font-size: 48px; color: #ffc107; margin-bottom: 20px;">‚ö†</div>
                    <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">
                        ${successCount} of ${totalCount} rate(s) copied successfully
                    </div>
                    <div style="font-size: 14px; color: #dc3545; margin-bottom: 10px;">
                        ${failureCount} operation(s) failed
                    </div>
                    <div style="font-size: 12px; color: #666;">
                        Check the console for error details.
                    </div>
                `;
            }
            
            summary.innerHTML = html;
            modal.style.display = 'flex';
        }

        function closeCompletionModal() {
            document.getElementById('completionModal').style.display = 'none';
        }

        function displayResults(results) {
            const resultsPanel = document.getElementById('resultsPanel');
            const resultsList = document.getElementById('resultsList');
            
            const successCount = results.filter(r => r.success).length;
            
            let html = `<div class="results-summary">${successCount}/${results.length} successful</div>`;
            html += '<div class="results-grid">';
            
            results.forEach(result => {
                html += `
                    <div class="result-item ${result.success ? 'success' : 'error'}">
                        <span>${result.success ? '‚úì' : '‚úó'}</span>
                        <span>${result.date}</span>
                        <span>${result.success ? `$${result.rate}` : 'Failed'}</span>
                        ${result.error ? `<span style="font-size: 9px; color: #721c24;">${result.error}</span>` : ''}
                    </div>
                `;
            });
            
            html += '</div>';
            resultsList.innerHTML = html;
            resultsPanel.style.display = 'block';
        }

        function clearResults() {
            document.getElementById('resultsPanel').style.display = 'none';
        }

        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'flex' : 'none';
        }
    </script>
</body>
</html>